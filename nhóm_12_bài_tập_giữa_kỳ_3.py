# -*- coding: utf-8 -*-
"""NhÃ³m 12_BÃ i táº­p giá»¯a ká»³ 3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1B7TnDF69ppl3mMkX-CBf23U18Y2FS40P

**Danh sÃ¡ch nhÃ³m 12:**


*  K224060792_Nguyá»…n ThÃ nh Lá»£i
*  K224060795_Tráº§n NhÆ° Cáº©m Ly
*  K224060766_TrÆ°Æ¡ng HoÃ ng Anh

**CÃ‚U 1: ÄÆ¯A DATASET LÃŠN MONGODB, TRUY XUáº¤T Dá»® LIá»†U Tá»ª MONOGODB  LÃŠN JYPYTER NOTBOOK**
"""

!pip install requests pymongo
!pip install pandas

from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi

uri = "mongodb+srv://loint22406_db_user:175200@cluster175.qdjbnkk.mongodb.net/?appName=Cluster175"

# Create a new client and connect to the server
client = MongoClient(uri, server_api=ServerApi('1'))

# Send a ping to confirm a successful connection
try:
    client.admin.command('ping')
    print("Pinged your deployment. You successfully connected to MongoDB!")
except Exception as e:
    print(e)

from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi

# Re-using the URI that successfully connected in the previous cell
uri = "mongodb+srv://loint22406_db_user:175200@cluster175.qdjbnkk.mongodb.net/?appName=Cluster175"

# Create a new client and connect to the server
client = MongoClient(uri, server_api=ServerApi('1'))

# Access the database named 'dtb'
db = client["dtb"]

# Access the collection named 'dtb'
collection = db["dtb"]

# Query the first 100 documents in the collection
documents = list(collection.find({}).limit(100))

# Print the retrieved documents
if documents:
    print(f"Found {len(documents)} documents in the 'dtb.dtb' collection:")
    for doc in documents:
        print(doc)
else:
    print("No documents found in the 'dtb.dtb' collection.")

"""Preview dá»¯ liá»‡u tá»« MongoDB"""

import pandas as pd

# Convert the list of documents to a Pandas DataFrame
df_documents = pd.DataFrame(documents)

# Display the DataFrame
display(df_documents)

"""**CÃ‚U 2. VAEX XÃ‚Y Dá»°NG á»¨NG Dá»¤NG PHÃ‚N TÃCH DATASET**"""

import pandas as pd
from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi

uri = "mongodb+srv://loint22406_db_user:175200@cluster175.qdjbnkk.mongodb.net/?appName=Cluster175"

client = MongoClient(uri, server_api=ServerApi('1'))
db = client["dtb"]
collection = db["dtb"]

documents = list(collection.find({}, {"_id": 0}))

df = pd.DataFrame(documents)
print(df.shape)
df.head()

df["Zipcode"] = df["Zipcode"].astype(str)
df.to_parquet("dtb_data.parquet")
print("âœ… ÄÃ£ xuáº¥t dá»¯ liá»‡u sang Parquet")

pip install vaex-core --no-build-isolation

import vaex

dfv = vaex.open("dtb_data.parquet")
dfv

"""PhÃ¢n tÃ­ch má»©c Ä‘á»™ tai náº¡n - sá»‘ lÆ°á»£ng tai náº¡n theo má»©c Ä‘á»™ nghiÃªm trá»ng"""

severity_stats = dfv.groupby("Severity", agg=vaex.agg.count())
severity_stats

"""PhÃ¢n tÃ­ch tai náº¡n theo thá»i gian (nÄƒm)"""

dfv['Start_Time'] = dfv['Start_Time'].astype('datetime64')
dfv['Year'] = dfv['Start_Time'].dt.year

accidents_per_year = dfv.groupby("Year", agg=vaex.agg.count()).sort("Year")
accidents_per_year

""" PhÃ¢n tÃ­ch áº£nh hÆ°á»Ÿng ngÃ y / Ä‘Ãªm"""

day_night_stats = dfv.groupby("Sunrise_Sunset", agg=vaex.agg.count())
day_night_stats

"""PhÃ¢n tÃ­ch khoáº£ng cÃ¡ch áº£nh hÆ°á»Ÿng cá»§a tai náº¡n"""

dfv.mean(dfv["Distance(mi)"]), dfv.max(dfv["Distance(mi)"])

"""PhÃ¢n tÃ­ch vai trÃ² cá»§a háº¡ táº§ng giao thÃ´ng"""

# Tai náº¡n táº¡i khu vá»±c cÃ³ Ä‘Ã¨n giao thÃ´ng
traffic_signal_stats = dfv.groupby("Traffic_Signal", agg=vaex.agg.count())
traffic_signal_stats

# Tai náº¡n táº¡i khu vá»±c cÃ³ biá»ƒn Stop
stop_stats = dfv.groupby("Stop", agg=vaex.agg.count())
stop_stats

"""CÃ‚U 3"""

!pip install streamlit pyngrok vaex pyarrow

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# import streamlit as st
# import pandas as pd
# 
# st.set_page_config(page_title="US Accident Analytics", layout="wide")
# st.title("ðŸš— PhÃ¢n tÃ­ch Tai náº¡n Giao thÃ´ng (Big Data)")
# 
# @st.cache_data
# def load_data():
#     df = pd.read_parquet("dtb_data.parquet")
#     df["Start_Time"] = pd.to_datetime(df["Start_Time"])
#     df["Year"] = df["Start_Time"].dt.year
#     return df
# 
# df = load_data()
# 
# # ===== METRICS =====
# col1, col2, col3 = st.columns(3)
# col1.metric("Tá»•ng sá»‘ tai náº¡n", f"{len(df):,}")
# col2.metric("Khoáº£ng cÃ¡ch TB (mile)", round(df["Distance(mi)"].mean(), 3))
# col3.metric("Khoáº£ng cÃ¡ch max (mile)", round(df["Distance(mi)"].max(), 3))
# 
# # ===== SEVERITY =====
# st.subheader("âš ï¸ Severity")
# severity = df.groupby("Severity").size()
# st.bar_chart(severity)
# 
# # ===== YEAR =====
# st.subheader("ðŸ“… Tai náº¡n theo nÄƒm")
# acc_year = df.groupby("Year").size().sort_index()
# st.line_chart(acc_year)
# 
# # ===== DAY / NIGHT =====
# st.subheader("ðŸŒž NgÃ y / ðŸŒ™ ÄÃªm")
# day_night = df.groupby("Sunrise_Sunset").size()
# st.bar_chart(day_night)
#

!streamlit run app.py

from pyngrok import ngrok
ngrok.connect(8501)

!streamlit run app.py &>/content/logs.txt &

from pyngrok import ngrok
ngrok.connect(8501)

"""4.1 Láº¥y token ngrok

VÃ o ðŸ‘‰ https://dashboard.ngrok.com

Copy Authtoken
390LK9yNoTnpgOAYuKiaaOp5z9C_714hb7PcgTQRvndfe4JzZ
"""

!pip install pyngrok

from pyngrok import ngrok

ngrok.set_auth_token("390LK9yNoTnpgOAYuKiaaOp5z9C_714hb7PcgTQRvndfe4JzZ")
public_url = ngrok.connect(8501)
public_url

!pip install streamlit pyngrok vaex pyarrow

!ls

!streamlit run app.py --server.port 8501 --server.address 0.0.0.0 &

!pkill streamlit

!nohup streamlit run app.py \
  --server.port 8501 \
  --server.address 0.0.0.0 \
  > streamlit.log 2>&1 &

!sleep 5
!curl http://127.0.0.1:8501

!sed -n '1,200p' streamlit.log

!ls -lh streamlit.log

!pip uninstall -y vaex vaex-core
!pip install vaex==4.16.0

!nohup streamlit run app.py \
  --server.port 8501 \
  --server.address 0.0.0.0 \
  > streamlit.log 2>&1 &

!sleep 5
!curl http://127.0.0.1:8501

!pip install pyngrok

!pip install streamlit pyngrok

!streamlit run app.py &>/content/logs.txt &



from pyngrok import ngrok

ngrok.set_auth_token("390LK9yNoTnpgOAYuKiaaOp5z9C_714hb7PcgTQRvndfe4JzZ")
public_url = ngrok.connect(8501)
public_url

"""Link thá»±c thi: https://lowell-gastronomic-fae.ngrok-free.dev/

Link Github:
"""